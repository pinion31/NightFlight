{"version":3,"sources":["../server/server.js"],"names":["mongoose","require","yelp","connect","Promise","global","clientId","process","env","CLIENT_ID_YELP","clientSecret","CLIENT_KEY_YELP","clubSchema","Schema","id","String","name","occupants","Array","userSchema","clubs","Clubber","model","Club","serverClubList","app","use","static","json","post","req","res","accessToken","then","response","client","jsonBody","access_token","searchRequest","term","location","body","query","search","results","businesses","forEach","club","findOne","err","result","console","log","clubResult","image_url","goingMessage","RSVPmessage","length","occ","newClub","save","push","JSON","stringify","catch","e","userAlreadyRSVPd","filter","user","username","findOneAndUpdate","get","send","listen"],"mappings":"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","file":"server.js","sourcesContent":["\r\nimport 'babel-polyfill';\r\nimport express from 'express';\r\nimport bodyParser from 'body-parser';\r\n\r\nconst mongoose = require('mongoose');\r\nconst yelp = require('yelp-fusion');\r\n\r\nmongoose.connect('mongodb://localhost/nightflight');\r\nmongoose.Promise = global.Promise;\r\n\r\nconst clientId = process.env.CLIENT_ID_YELP;\r\nconst clientSecret = process.env.CLIENT_KEY_YELP;\r\n\r\nconst clubSchema = mongoose.Schema({\r\n  id: String,\r\n  name: String,\r\n  occupants: Array,\r\n\r\n});\r\n\r\nconst userSchema = mongoose.Schema({\r\n  id: String,\r\n  name: String,\r\n  clubs: Array,\r\n});\r\n\r\nconst Clubber = mongoose.model('user', userSchema);\r\nconst Club = mongoose.model('club', clubSchema);\r\n\r\nlet serverClubList = [];\r\n\r\nconst app = express();\r\n\r\napp.use(express.static('static'));\r\napp.use(bodyParser.json());\r\n\r\napp.post('/list', (req, res) => {\r\n  yelp.accessToken(clientId, clientSecret).then((response) => {\r\n    const client = yelp.client(response.jsonBody.access_token);\r\n\r\n    const searchRequest = {\r\n      term: 'nightlife',\r\n      location: req.body.query,\r\n    };\r\n\r\n    client.search(searchRequest).then((response) => {\r\n      const results = response.jsonBody.businesses;\r\n      serverClubList = [];\r\n\r\n      results.forEach((club) => {\r\n        Club.findOne({id: club.id}, (err, result) => {\r\n          if (err) { console.log(`error ${err}`); }\r\n\r\n          const clubResult = {\r\n            id: club.id,\r\n            name: club.name,\r\n            occupants: [],\r\n            image_url: club.image_url,\r\n            goingMessage: '0 GOING',\r\n            RSVPmessage: 'RSVP'\r\n          };\r\n\r\n          if (result) { // if club already exists in db\r\n            clubResult.occupants = result.occupants;\r\n            clubResult.goingMessage = `${result.occupants.length} GOING`;\r\n            // checks and  indicates if user is already going to this club\r\n            result.occupants.forEach((occ) => {\r\n              if (occ === req.body.name) {\r\n                clubResult.goingMessage = `${result.occupants.length} GOING - YOU'RE GOING TO THIS CLUB TONIGHT!`;\r\n                clubResult.RSVPmessage = 'unRSVP';\r\n              }\r\n            });\r\n          } else { // create new Club entry if does not exist in db\r\n            const newClub = new Club({\r\n              id: club.id,\r\n              name: club.name,\r\n              occupants: [],\r\n              goingMessage: '0 GOING',\r\n              RSVPmessage: 'RSVP'\r\n            });\r\n\r\n            // save new Club entry\r\n            newClub.save((err) => {\r\n              if (err) return err;\r\n            });\r\n          }\r\n\r\n          serverClubList.push(clubResult);\r\n\r\n          if (serverClubList.length === results.length) {\r\n            res.json(JSON.stringify(serverClubList));\r\n          }\r\n        });\r\n      });\r\n    });\r\n  }).catch((e) => {\r\n    console.log(e);\r\n  });\r\n});\r\n\r\n// this url doubles as removeSelf too - user can toggle adding self and removing self\r\napp.post('/addSelf', (req, res) => {\r\n  serverClubList.forEach((club) => {\r\n    if (club.id === req.body.id) { // finds corresponding club to add or remove user from\r\n      let userAlreadyRSVPd = false;\r\n\r\n      club.occupants = club.occupants.filter((user) => {\r\n        // checks if user has already RSVP'ed--if so, removes user from occupant list\r\n        if (user === req.body.username) {\r\n          userAlreadyRSVPd = true;\r\n          // resets goingMessage to one less occupant after user removal\r\n          club.goingMessage = `${club.occupants.length - 1} GOING`;\r\n          club.RSVPmessage = 'RSVP'; // resets RSVP button from unRSVP to RSVP\r\n        } else {\r\n          return user;\r\n        }\r\n      });\r\n\r\n      if (!userAlreadyRSVPd) { // if user has not already RSVP'd, add user as going\r\n        club.occupants.push(req.body.username);\r\n        club.goingMessage = `${club.occupants.length} GOING - YOU'RE GOING TO THIS CLUB TONIGHT!`;\r\n        club.RSVPmessage = 'unRSVP';\r\n      }\r\n\r\n      // updates occupant list in DB\r\n      Club.findOneAndUpdate({id: club.id}, {\r\n        occupants: club.occupants,\r\n        goingMessage: club.goingMessage,\r\n        RSVPmessage: club.RSVPmessage},\r\n      (err) => {\r\n        if (err) return err;\r\n      });\r\n    }\r\n  });\r\n\r\n  res.json(JSON.stringify(serverClubList));\r\n});\r\n\r\napp.get('*', (req, res) => {\r\n  res.send('no match');\r\n});\r\n\r\napp.listen(3000, () => {\r\n  console.log('App started on port 3000');\r\n});\r\n"]}