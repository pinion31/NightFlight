{"version":3,"sources":["../server/server.js"],"names":["mongoose","require","connect","Promise","global","yelp","clientId","process","env","CLIENT_ID_YELP","clientSecret","CLIENT_KEY_YELP","idAssigner","Schema","counter","Number","clubSchema","id","String","name","occupants","Array","userSchema","clubs","Clubber","model","Club","Counter","app","use","static","json","post","req","res","accessToken","then","client","response","jsonBody","access_token","searchRequest","term","location","body","query","search","results","businesses","dbData","from","clubsToReturn","forEach","findOne","club","err","result","console","log","clubResult","image_url","newClub","save","dir","push","length","JSON","stringify","catch","e","get","send","listen"],"mappings":"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","file":"server.js","sourcesContent":["'use strict';\r\n\r\nimport 'babel-polyfill';\r\nimport SourceMapSupport from 'source-map-support';\r\nimport express from 'express';\r\nimport bodyParser from 'body-parser';\r\nconst mongoose = require('mongoose');\r\nmongoose.connect('mongodb://localhost/nightflight');\r\nmongoose.Promise = global.Promise;\r\n\r\nconst yelp = require('yelp-fusion');\r\n\r\nconst clientId = process.env.CLIENT_ID_YELP;\r\nconst clientSecret = process.env.CLIENT_KEY_YELP;\r\n\r\nconst idAssigner = mongoose.Schema({\r\n  counter:Number,\r\n});\r\n\r\nconst clubSchema = mongoose.Schema({\r\n  id: String,\r\n  name: String,\r\n  occupants: Array,\r\n\r\n});\r\n\r\nconst userSchema = mongoose.Schema({\r\n  id: String,\r\n  name: String,\r\n  clubs: Array,\r\n});\r\n\r\nconst Clubber = mongoose.model('user', userSchema);\r\nconst Club = mongoose.model('club', clubSchema);\r\nconst Counter = mongoose.model('counter', idAssigner);\r\n\r\n\r\n\r\nconst app = express();\r\n\r\napp.use(express.static('static'));\r\napp.use(bodyParser.json());\r\n\r\napp.post('/list', (req, res) => {\r\n\r\n  yelp.accessToken(clientId, clientSecret).then(response => {\r\n  const client = yelp.client(response.jsonBody.access_token);\r\n\r\n  const searchRequest = {\r\n    term:'nightlife',\r\n    location: req.body.query,\r\n  };\r\n\r\n  client.search(searchRequest).then(response => {\r\n    const results = response.jsonBody.businesses;\r\n    const dbData = Array.from(response.jsonBody.businesses);\r\n    const clubsToReturn = [];\r\n\r\n\r\n\r\n    results.forEach(club => {\r\n      Club.findOne({id:club.id}, (err,result) => {\r\n        if (err) {console.log(`error ${err}`);}\r\n\r\n        const clubResult =  {\r\n              id: club.id,\r\n              name:club.name,\r\n              occupants:[],\r\n              image_url:club.image_url\r\n            };\r\n\r\n        if (result) { // if club already exists in db\r\n            clubResult.occupants = result.occupants;\r\n        }\r\n        else {//create new Club entry if does not exist in db\r\n          const newClub = new Club({\r\n            id: club.id,\r\n            name: club.name,\r\n            occupants: [],\r\n\r\n          });\r\n\r\n          //save new Club entry\r\n          newClub.save((err, club) => {\r\n            if (err) {\r\n               console.log('error!');\r\n               console.dir(err);\r\n            }\r\n            console.log('club saved');\r\n          });\r\n\r\n        }\r\n\r\n        clubsToReturn.push(clubResult);\r\n\r\n       // console.log(`length = ${clubsToReturn.length}`);\r\n\r\n        if (clubsToReturn.length === results.length) {\r\n          console.dir(clubResult);\r\n          res.json(JSON.stringify(clubsToReturn));\r\n        }\r\n\r\n      });\r\n    });\r\n  });\r\n}).catch(e => {\r\n    console.log(e);\r\n  });\r\n});\r\n\r\napp.get('*', (req, res) => {\r\n    res.send('no match');\r\n  });\r\napp.listen(3000, () => {\r\n  console.log('App started on port 3000');\r\n\r\n});"]}